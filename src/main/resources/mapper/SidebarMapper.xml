<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.LlmSpring.sidebar.SidebarMapper">

    <select id="selectMySidebarProject" resultType="com.example.LlmSpring.sidebar.response.SidebarResponseDTO$SidebarProjectDTO">
        SELECT
            p.project_id AS projectId,
            p.name AS name,
            p.status AS status,
            p.start_date AS startDate,
            p.end_date AS endDate,
            pm.is_favorite AS isFavorite  FROM Project p
                                                   JOIN ProjectMember pm ON p.project_id = pm.project_id
        WHERE pm.user_id = #{userId}
          AND p.deleted_at IS NULL
          AND pm.deleted_at IS NULL
          AND p.status = 'ACTIVE'
        ORDER BY pm.is_favorite DESC, p.name ASC
    </select>

    <select id="selectProjectInfo" resultType="map">
        SELECT
            name,
            status,
            daily_report_time AS dailyReportTime,
            github_repo_url AS githubUrl
        FROM Project
        WHERE project_id = #{projectId}
    </select>

    <select id="countTodayMyReport" resultType="int">
        SELECT COUNT(*) FROM DailyReport
        WHERE project_id = #{projectId} AND user_id = #{userId} AND report_date = #{date}
    </select>

    <select id="selectMyActiveTasks" resultType="com.example.LlmSpring.sidebar.response.ProjectSidebarResponseDTO$SidebarTaskDTO">
        SELECT
            t.task_id AS taskId,
            t.title AS title,
            t.priority AS priority,
            t.due_date AS dueDate,
            t.status AS status        FROM Task t
                                               LEFT JOIN TaskUser tu ON t.task_id = tu.task_id
        WHERE t.project_id = #{projectId}
          AND t.deleted_at IS NULL
          AND t.status != 'DONE'
          AND (
             tu.user_id = #{userId}
           OR t.user_id = #{userId}
            )
        GROUP BY t.task_id
        ORDER BY t.priority DESC, t.due_date ASC
            LIMIT 100
    </select>

    <select id="selectMyActiveIssues" resultType="com.example.LlmSpring.sidebar.response.ProjectSidebarResponseDTO$SidebarIssueDTO">
        SELECT
            i.issue_id AS issueId,
            i.title    AS title,
            i.status   AS status,
            i.priority AS priority
        FROM Issue i
                 INNER JOIN Issue_Assignee ia ON i.issue_id = ia.issue_id
        WHERE i.project_id = #{projectId}
          AND ia.user_id = #{userId}
          AND i.status != 'DONE'
          AND i.archived_at IS NULL
        ORDER BY i.priority ASC, i.due_date ASC  LIMIT 5
    </select>

    <select id="existsFavorite" resultType="int">
        SELECT COUNT(*)
        FROM ProjectMember
        WHERE project_id = #{projectId}
          AND user_id = #{userId}
          AND is_favorite = 1  </select>

    <update id="insertFavorite">
        UPDATE ProjectMember
        SET is_favorite = 1    WHERE project_id = #{projectId}
                                 AND user_id = #{userId}
    </update>

    <update id="deleteFavorite">
        UPDATE ProjectMember
        SET is_favorite = 0    WHERE project_id = #{projectId}
                                 AND user_id = #{userId}
    </update>
</mapper>