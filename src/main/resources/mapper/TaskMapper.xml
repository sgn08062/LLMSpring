<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.LlmSpring.task.TaskMapper">

    <select id="getProjectRole" resultType="String">
        SELECT role
        FROM ProjectMember
        WHERE project_id = #{projectId}
          AND user_id = #{userId}
          AND deleted_at IS NULL
    </select>

    <select id="selectCheckListById" resultType="com.example.LlmSpring.task.TaskCheckListVO">
        SELECT checklist_id AS checkListId, content, status, created_at AS createAt, task_id AS taskId
        FROM TaskCheckList WHERE checklist_id = #{checkListId}
    </select>

    <insert id="insertTask" useGeneratedKeys="true" keyProperty="taskId">
        INSERT INTO Task (project_id, user_id, title, content, status, priority, due_date, branch)
        VALUES (#{projectId}, #{userId}, #{title}, #{content}, #{status}, #{priority}, #{dueDate}, #{branch})
    </insert>

    <select id="selectTasksByProjectId" resultType="com.example.LlmSpring.task.TaskVO">
        SELECT * FROM Task WHERE project_id = #{projectId} AND deleted_at IS NULL ORDER BY created_at DESC
    </select>

    <select id="selectTaskById" resultType="com.example.LlmSpring.task.TaskVO">
        SELECT * FROM Task WHERE task_id = #{taskId} AND deleted_at IS NULL
    </select>

    <update id="updateTaskStatus">
        UPDATE Task SET status = #{status} WHERE task_id = #{taskId}
    </update>

    <update id="updateTask">
        UPDATE Task
        SET title = #{title}, content = #{content}, priority = #{priority}, branch = #{branch}, due_date = #{dueDate}, updated_at = NOW()
        WHERE task_id = #{taskId}
    </update>

    <update id="softDeleteTask">
        UPDATE Task SET deleted_at = NOW() WHERE task_id = #{taskId}
    </update>

    <insert id="insertTaskUser">
        INSERT INTO TaskUser (task_id, user_id) VALUES (#{taskId}, #{userId})
    </insert>

    <select id="selectTaskUsers" resultType="String">
        SELECT user_id FROM TaskUser WHERE task_id = #{taskId} AND deleted_at IS NULL
    </select>

    <delete id="deleteTaskUsers">
        DELETE FROM TaskUser WHERE task_id = #{taskId}
    </delete>

    <select id="selectCheckLists" resultType="com.example.LlmSpring.task.TaskCheckListVO">
        SELECT checklist_id AS checkListId, content, status, created_at AS createAt, task_id AS taskId
        FROM TaskCheckList WHERE task_id = #{taskId}
    </select>

    <insert id="insertCheckList">
        INSERT INTO TaskCheckList (task_id, content, status) VALUES (#{taskId}, #{content}, false)
    </insert>

    <delete id="deleteCheckList">
        DELETE FROM TaskCheckList WHERE checklist_id = #{checkListId}
    </delete>

    <update id="updateCheckListStatus">
        UPDATE TaskCheckList SET status = #{status} WHERE checklist_id = #{checkListId}
    </update>

    <select id="selectChats" resultType="map">
        SELECT * FROM TaskChat WHERE task_id = #{taskId} ORDER BY date ASC
    </select>

    <insert id="insertChat">
        INSERT INTO TaskChat (task_id, user_id, content) VALUES (#{taskId}, #{userId}, #{content})
    </insert>

    <insert id="insertTaskLog">
        INSERT INTO TaskLog (task_id, type, content, user_id)
        VALUES (#{taskId}, #{type}, #{content}, #{userId})
    </insert>

    <select id="selectLogs" resultType="com.example.LlmSpring.task.TaskLogVO">
        SELECT
            log_id AS logId,
            type,
            content,
            meta_data AS metaData,
            created_at AS createAt,
            task_id AS taskId,
            user_id AS userId
        FROM TaskLog
        WHERE task_id = #{taskId}
        ORDER BY created_at DESC
    </select>

</mapper>